<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fmcd.market.Mapper.ProductMapper">

    <resultMap id="ProductResultMap" type="com.fmcd.market.entity.Products.Product">
        <id property="productId" column="product_id"/>
        <result property="name" column="name"/>
        <result property="categoryId" column="category_id"/>
        <result property="price" column="price"/>
        <result property="unit" column="unit"/>
        <result property="imageUrl" column="image_url"/>
        <result property="rgbJson" column="rgb_json"/>
        <result property="status" column="status"/>
        <result property="confidence" column="confidence"/>
        <result property="isRecommend" column="is_recommend"/>
        <result property="isNew" column="is_new"/>
        <result property="recommendDate" column="recommend_date"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="creator" column="creator"/>
        <result property="updator" column="updator"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="deletedAt" column="deleted_at"/>
    </resultMap>
    <!-- 查询所有未删除商品 -->
    <select id="getAllNoDeleteStatusProducts" resultMap="ProductResultMap">
        SELECT * FROM Products WHERE is_deleted = 0;
    </select>


    <!-- 根据关键字模糊查询商品名称 -->
    <select id="getAllNoDeleteStatusProductsByKeyword" parameterType="string" resultMap="ProductResultMap">
        SELECT * FROM Products
        WHERE is_deleted = 0
          AND name LIKE CONCAT('%', #{keyword}, '%')
    </select>


    <select id="getAllProducts" resultMap="ProductResultMap">
        SELECT * FROM Products ;
    </select>

    <select id="getProductById" parameterType="int" resultMap="ProductResultMap">
        SELECT * FROM Products WHERE product_id = #{productId} AND is_deleted = 0;
    </select>

    <!-- 根据id查询所有的商品 包括已删除商品-->
    <select id="getProductAllById" parameterType="int" resultMap="ProductResultMap">
        SELECT * FROM Products WHERE product_id = #{productId};
    </select>

    <!-- 更新商品信息 -->
    <update id="updateProductInfo" parameterType="com.fmcd.market.entity.Products.Product">
        UPDATE Products
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="price != null">price = #{price},</if>
            <if test="unit != null">unit = #{unit},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="isRecommend != null">is_recommend = #{isRecommend},</if>
            <if test="isNew != null">is_new = #{isNew},</if>
            <if test="status != null">status = #{status},</if>
            updator = #{updator},
            updated_at = NOW()
        </set>
        WHERE product_id = #{productId}
    </update>

    <!-- 商品上下架 -->
    <update id="updateProductStatus">
        UPDATE Products
        <set>
            status = #{status},
            is_deleted = CASE WHEN #{status} = 'deleted' THEN 1 ELSE 0 END,
            deleted_at = CASE WHEN #{status} = 'on_sale' THEN NULL ELSE NOW() END,
            updator = #{operatorId},
            updated_at = NOW()
        </set>
        WHERE product_id = #{productId}
    </update>





    <!-- 新品标记 -->
    <update id="markProductAsNew">
        UPDATE PRODUCTS
        SET is_new = #{isNew},
            updator = #{operatorId},
            updated_at = NOW()
        WHERE product_id = #{productId}
          AND is_deleted = 0
    </update>

</mapper>
